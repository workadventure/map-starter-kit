<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <meta name="title" content="WorkAdventure Starter Kit - Self-hosted">

    <link href="public/styles.css" rel="stylesheet">

    <title>Your maps - Self-hosted</title>
    <link rel="icon" href="/images/favicon.svg" type="image/svg+xml">
    <script type="module">
        document.addEventListener("DOMContentLoaded", async () => {
            await import('/public/assets/index.js');
            const main = document.querySelector('main .maps-container');
            const emptyEl = document.getElementById('maps-empty');
            const errorEl = document.getElementById('maps-error');
            const loadingEl = document.getElementById('maps-loading');

            try {
                const response = await fetch('/uploader/maps-storage-list');
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.message || `HTTP ${response.status}`);
                }
                const { maps, mapStorageUrl, playBaseUrl } = await response.json();

                loadingEl.style.display = 'none';

                if (!maps || maps.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }

                // Maps are already hydrated by the API (path, mapName, mapDescription, mapImage, mapUrl, etc.)
                // Play URL: use PLAY_BASE_URL if set, else derive from map-storage URL (replace "map-storage" by "play")
                const playBase = (playBaseUrl && playBaseUrl.trim())
                    ? playBaseUrl.replace(/\/$/, '')
                    : (mapStorageUrl || '').replace(/\/$/, '').replace('map-storage', 'play');
                const defaultImageUrl = '/public/images/unknown-room-image.png';

                maps.forEach(map => {
                    const section = document.createElement('section');
                    section.className = 'card-map';
                    const hasImage = map.mapImage && map.mapImage.length > 0;
                    const imageUrl = hasImage ? map.mapImage : defaultImageUrl;
                    const coverStyle = `background-image: url('${imageUrl.replace(/'/g, "\\'")}');`;
                    const coverClass = 'map-cover' + (hasImage ? '' : ' map-cover--no-image');
                    const wamPath = (map.wamFileUrl || '').replace(/^\//, '');
                    const openUrl = playBase ? `${playBase}/~/${wamPath}` : null;

                    const desc = (map.mapDescription && map.mapDescription.trim()) ? map.mapDescription : 'No description';
                    const licence = (map.mapCopyright && map.mapCopyright.trim()) ? map.mapCopyright : 'No licence existing';
                    section.innerHTML = `
                        <div class="${coverClass}" style="${coverStyle}"></div>
                        <div class="map-name">${escapeHtml(map.mapName)}</div>
                        <div class="map-detail">
                            <div class="map-file"><strong>${escapeHtml(map.filename)}</strong></div>
                        </div>
                        <div class="map-desc">${escapeHtml(desc)}</div>
                        <div class="map-copyright">${escapeHtml(licence)}</div>
                        <div class="map-testurl">
                            ${openUrl
                                ? `<a href="${escapeHtml(openUrl)}" class="btn" target="_blank" rel="noopener">Open map</a>`
                                : `<button type="button" class="btn btn-secondary copy-path-btn" data-path="${escapeHtml(wamPath)}">Copy path</button>
                                   <span class="map-path-hint">Path: ${escapeHtml(wamPath)}</span>`}
                        </div>
                    `;

                    const copyBtn = section.querySelector('.copy-path-btn');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', () => {
                            navigator.clipboard.writeText(copyBtn.dataset.path || '');
                            copyBtn.textContent = 'Copied!';
                            setTimeout(() => { copyBtn.textContent = 'Copy path'; }, 2000);
                        });
                    }

                    main.appendChild(section);
                });

                // Background fade from first map image if available
                const firstImg = maps[0]?.mapImage;
                if (firstImg && typeof window.createBackgroundImageFade === 'function') {
                    window.createBackgroundImageFade([firstImg]);
                }
            } catch (e) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                if (document.getElementById('error-detail')) {
                    document.getElementById('error-detail').textContent = e.message || 'Failed to load maps';
                }
            }
        });

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</head>

<body>
<div class="content">
    <header>
        <div class="logo">
            <a href="https://workadventu.re/" target="_blank" title="Workadventure">
                <img src="public/images/logo.svg" alt="Workadventure logo" height="36" />
            </a>
        </div>
        <div style="flex-grow: 1;"></div>
        <div class="socials">
            <a href="https://discord.gg/G6Xh9ZM9aR" target="_blank" title="discord">
                <img src="/public/images/brand-discord.svg" alt="discord">
            </a>
            <a href="https://github.com/thecodingmachine/workadventure" target="_blank" title="github">
                <img src="/public/images/brand-github.svg" alt="github">
            </a>
            <a href="https://www.youtube.com/channel/UCXJ9igV-kb9gw1ftR33y5tA" target="_blank" title="youtube">
                <img src="/public/images/brand-youtube.svg" alt="youtube">
            </a>
            <a href="https://twitter.com/Workadventure_" target="_blank" title="twitter">
                <img src="/public/images/brand-x.svg" alt="X">
            </a>
            <a href="https://www.linkedin.com/company/workadventu-re" target="_blank" title="linkedin">
                <img src="/public/images/brand-linkedin.svg" alt="linkedin">
            </a>
        </div>
        <div class="btn-header-wrapper">
            <a href="https://discord.gg/G6Xh9ZM9aR" target="_blank" class="btn btn-light">Talk to the community</a>
            <a href="https://docs.workadventu.re/map-building/" target="_blank" class="btn">Documentation</a>
        </div>
    </header>
    <main class="container">
        <section class="form-center steps" style="max-width: 100%; align-items: center;">
            <img src="public/images/badumtss.svg" alt="Success">
            <h1>
                Your map is ready to <strong>explore</strong> and <strong>share</strong>
            </h1>
            <p class="sub-heading" style="margin-top: 8px;">
                Maps published on your map storage are listed below. Open or copy the path to use them in your WorkAdventure play instance.
            </p>

            <div id="maps-loading" style="margin-top: 24px;">
                <p>Loading maps from map storage...</p>
            </div>
            <div id="maps-error" style="display: none; margin-top: 24px; color: #ff4444;">
                <p>Could not load the list of maps. <span id="error-detail"></span></p>
            </div>
            <div id="maps-empty" style="display: none; margin-top: 24px;">
                <p>No maps found in your map storage yet.</p>
            </div>

            <div class="maps-container" style="display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; margin-top: 24px; width: 100%;">
                <!-- Map cards injected here -->
            </div>
        </section>
    </main>
    <div class="button-wrapper">
        <div>
            <a href="step3-steps-selfhosted" class="btn btn-ghost">
                Previous
            </a>
        </div>
        <div style="flex-grow: 1;">
        </div>
    </div>
</div>
<div class="bg"></div>
<style>
    .map-path-hint {
        font-size: 12px;
        opacity: 0.8;
        word-break: break-all;
    }
    .map-cover--no-image {
        background-color: #1b2a41;
        background-size: cover;
        background-position: center;
    }
</style>
</body>

</html>
